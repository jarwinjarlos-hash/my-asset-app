<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Tracker (Cloud Sync)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3b82f6/FFFFFF?text=AT">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Custom styles for the responsive PWA look */
        body { font-family: 'Inter', sans-serif; }
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fca5a5; /* Red-300 */
            color: #b91c1c; /* Red-700 */
            text-align: center;
            padding: 8px 0;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .offline-banner.show {
            transform: translateY(0);
        }
        /* Mobile-first adjustments for layout */
        .grid-container {
            grid-template-columns: 1fr;
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .text-clip {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Style for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a', '950': '#172554'
                        },
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Offline Banner -->
    <div id="offline-banner" class="offline-banner">
        <span id="offline-banner-message"></span>
    </div>

    <div class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Header & Controls -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-primary-600 dark:text-primary-400">AssetTrack</h1>
            <div class="flex items-center space-x-3">
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 transition">
                    <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
                <button id="privacy-toggle-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 transition" title="Toggle Privacy Mode">
                    <!-- Eye Icon (On) -->
                    <svg id="privacy-on-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <!-- Eye Slash Icon (Off) -->
                    <svg id="privacy-off-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 104.243 4.243M9.879 16.121A4.997 4.997 0 015 12c0-1.077.301-2.072.825-2.925m11.375 0c-.266-.432-.575-.838-.916-1.215M4.875 18.825L10.5 13.19M2 2l20 20"></path></svg>
                </button>
                <button id="settings-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 transition" title="Settings">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Current Status -->
        <div id="auth-status" class="mb-4 text-sm text-center p-2 rounded-lg bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300">
            Authenticating user and connecting to cloud...
        </div>
        <div id="rates-status" class="mb-6 text-sm text-right text-gray-500 dark:text-gray-400">
            Exchange Rates Status: Loading...
        </div>

        <!-- Portfolio Summary Card -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Total Portfolio Value</h2>
            <div class="flex items-end justify-between">
                <p id="total-value" class="text-4xl font-bold text-primary-600 dark:text-primary-400">$0.00</p>
                <div class="text-right">
                    <p id="total-24h-change" class="text-lg font-medium text-gray-600 dark:text-gray-400"></p>
                    <p id="base-currency-display" class="text-sm text-gray-500 dark:text-gray-400">Base: USD</p>
                </div>
            </div>
            <canvas id="portfolio-chart" class="mt-4"></canvas>
        </div>

        <!-- Add Asset Form -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Asset</h2>
            <form id="add-asset-form" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <input type="text" id="asset-name" placeholder="Name (e.g., BTC, Stock A)" required
                       class="col-span-2 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                <input type="number" id="asset-quantity" placeholder="Quantity" required min="0" step="any"
                       class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                <input type="number" id="asset-price" placeholder="Price (USD)" required min="0" step="any"
                       class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                <input type="number" id="asset-24h-change" placeholder="24h Change (%)" step="any"
                       class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                <button type="submit" class="col-span-2 md:col-span-4 bg-primary-600 text-white p-3 rounded-lg font-semibold hover:bg-primary-700 transition shadow-md">Add Asset</button>
            </form>
        </div>

        <!-- Asset List -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">My Assets (<span id="asset-count">0</span>)</h2>
            <div id="asset-list" class="space-y-4">
                <p id="no-assets-message" class="text-gray-500 dark:text-gray-400 text-center">No assets added yet.</p>
                <!-- Asset items will be inserted here -->
            </div>
        </div>

        <!-- Settings Modal (Initially Hidden) -->
        <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-2xl font-bold">Settings</h3>
                    <button id="close-settings-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <label class="block">
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Base Currency</span>
                        <input type="text" id="base-currency-input" list="currency-list" value="USD"
                               class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500 uppercase">
                        <datalist id="currency-list"></datalist>
                    </label>

                    <label class="block">
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Display Decimals</span>
                        <input type="number" id="decimal-places-input" min="0" max="10" value="2"
                               class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                    </label>

                    <div class="pt-4 border-t dark:border-gray-700">
                        <h4 class="text-lg font-medium mb-2">Data Management</h4>
                        <button id="export-btn" class="w-full bg-yellow-500 text-white p-2 rounded-lg font-semibold hover:bg-yellow-600 transition mb-2 shadow-sm">Export Data (ZIP)</button>
                        <button id="import-btn" class="w-full bg-green-500 text-white p-2 rounded-lg font-semibold hover:bg-green-600 transition mb-2 shadow-sm">Import Data (ZIP)</button>
                        <button id="clear-all-data-btn" class="w-full bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700 transition shadow-sm">Clear All Cloud Data</button>
                    </div>

                    <div class="pt-4 border-t dark:border-gray-700">
                        <h4 class="text-lg font-medium mb-2">User & Sync Info</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">User ID: <span id="user-id-display" class="font-mono text-xs break-all">Loading...</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">App ID: <span id="app-id-display" class="font-mono text-xs break-all">Loading...</span></p>
                    </div>

                </div>

                <button id="save-settings-btn" class="mt-6 w-full bg-primary-600 text-white p-3 rounded-lg font-semibold hover:bg-primary-700 transition shadow-md">Save Settings</button>
            </div>
        </div>

    </div>

    <!-- Data Import/Export Input -->
    <input type="file" id="import-file-input" accept=".zip" class="hidden">

    <script type="module">
        // Import Firebase modules using CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Global application state
        let assets = [];
        let baseCurrency = 'USD';
        let exchangeRates = { USD: 1.0 };
        let decimalPlaces = 2;
        let isPrivacyMode = false;
        let chartInstance = null;
        let isAuthReady = false;
        let db;
        let auth;
        let currentUserId = null;

        // --- Firebase/Firestore Configuration (MANDATORY GLOBALS) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-asset-tracker-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // -----------------------------------------------------------

        // DOM elements
        const totalValueEl = document.getElementById('total-value');
        const total24hChangeEl = document.getElementById('total-24h-change');
        const baseCurrencyDisplayEl = document.getElementById('base-currency-display');
        const assetCountEl = document.getElementById('asset-count');
        const assetListEl = document.getElementById('asset-list');
        const noAssetsMessageEl = document.getElementById('no-assets-message');
        const addAssetForm = document.getElementById('add-asset-form');
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const baseCurrencyInput = document.getElementById('base-currency-input');
        const decimalPlacesInput = document.getElementById('decimal-places-input');
        const currencyDatalist = document.getElementById('currency-list');
        const privacyToggleBtn = document.getElementById('privacy-toggle-btn');
        const privacyOnIcon = document.getElementById('privacy-on-icon');
        const privacyOffIcon = document.getElementById('privacy-off-icon');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const offlineBanner = document.getElementById('offline-banner');
        const offlineBannerMessage = document.getElementById('offline-banner-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const appIdDisplay = document.getElementById('app-id-display');
        const authStatusEl = document.getElementById('auth-status');
        const ratesStatusEl = document.getElementById('rates-status');

        // --- Utility Functions ---

        /** Converts amount from USD to the base currency. */
        const convertToBase = (usdAmount) => {
            const rate = exchangeRates[baseCurrency] || 1.0;
            return usdAmount * rate;
        };

        /** Formats a number as a currency string. */
        const formatCurrency = (number) => {
            if (isPrivacyMode) return '***';
            const value = parseFloat(number);
            return value.toLocaleString('en-US', {
                style: 'currency',
                currency: baseCurrency,
                minimumFractionDigits: decimalPlaces,
                maximumFractionDigits: decimalPlaces,
            });
        };

        /** Formats a percentage. */
        const formatPercentage = (number) => {
            if (isPrivacyMode) return '***';
            return (parseFloat(number) || 0).toFixed(2) + '%';
        };

        /** Calculates the total USD value of the portfolio. */
        const calculateTotalValue = () => {
            return assets.reduce((sum, asset) => sum + (asset.quantity * asset.price), 0);
        };

        /** Calculates the total 24h change in USD value. */
        const calculateTotal24hChange = () => {
            let totalStartValue = 0;
            let totalEndValue = 0;

            assets.forEach(asset => {
                const changeRate = (parseFloat(asset.change || 0) / 100);
                const currentValue = asset.quantity * asset.price;
                const startValue = currentValue / (1 + changeRate);

                totalEndValue += currentValue;
                totalStartValue += startValue;
            });

            if (totalStartValue === 0) return 0;

            const changeAmount = totalEndValue - totalStartValue;
            const changePercent = (changeAmount / totalStartValue) * 100;

            return { amount: changeAmount, percent: changePercent };
        };

        // --- Firebase Firestore Functions ---

        /** Gets the document reference for the current user's asset data. */
        const getAssetDocRef = () => {
            if (!db || !currentUserId) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/asset-tracker-data/data
            return doc(db, 'artifacts', appId, 'users', currentUserId, 'asset-tracker-data', 'data');
        };

        /** Saves the current assets array to Firestore. */
        const saveAssets = async () => {
            const docRef = getAssetDocRef();
            if (!docRef) return;

            try {
                // IMPORTANT: The assets array might contain complex data structures, so we serialize it.
                // However, since assets are simple objects here, we can save them directly for simplicity,
                // but for maximum safety in complex scenarios, serialization is recommended.
                await setDoc(docRef, { assets: assets, lastUpdated: new Date() });
                console.log("Assets saved to Firestore successfully.");
            } catch (error) {
                console.error("Error saving assets to Firestore:", error);
            }
        };

        /** Sets up a real-time listener for asset data from Firestore. */
        const loadAssets = () => {
            const docRef = getAssetDocRef();
            if (!docRef) {
                authStatusEl.textContent = 'Error: Database or User ID not available.';
                return;
            }

            // Set up a real-time listener
            onSnapshot(docRef, (doc) => {
                if (doc.exists() && doc.data().assets) {
                    // Update the local state with the cloud data
                    assets = doc.data().assets.map(asset => ({
                        ...asset,
                        // Ensure numerical fields are parsed correctly on load
                        quantity: parseFloat(asset.quantity),
                        price: parseFloat(asset.price),
                        change: parseFloat(asset.change),
                    }));
                    console.log("Assets loaded/synced from Firestore.");
                } else {
                    // If the document doesn't exist (first run), initialize with an empty array
                    assets = [];
                    console.log("No asset data found in cloud, initializing local state.");
                    saveAssets(); // Create the initial document
                }
                renderAll();
                authStatusEl.textContent = `Cloud Sync: Connected (User: ${currentUserId.substring(0, 8)}...)`;
                authStatusEl.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'bg-red-100', 'dark:bg-red-900');
                authStatusEl.classList.add('bg-green-100', 'dark:bg-green-900');
            }, (error) => {
                console.error("Firestore listener error:", error);
                authStatusEl.textContent = `Cloud Sync Error: ${error.code}. Data is local-only.`;
                authStatusEl.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'bg-green-100', 'dark:bg-green-900');
                authStatusEl.classList.add('bg-red-100', 'dark:bg-red-900');
                // Revert to local storage if Firestore fails, as a fallback (though not ideal)
                assets = JSON.parse(localStorage.getItem('assets') || '[]');
                renderAll();
            });
        };

        // --- Main Rendering and Logic ---

        const renderChart = () => {
            if (chartInstance) {
                chartInstance.destroy();
            }

            const totalValue = calculateTotalValue();
            if (totalValue === 0 || assets.length === 0) {
                chartInstance = null;
                return;
            }

            const data = {
                labels: assets.map(a => a.name),
                datasets: [{
                    label: `Value in ${baseCurrency}`,
                    data: assets.map(a => convertToBase(a.quantity * a.price)),
                    backgroundColor: assets.map((_, i) => `hsl(${i * 60}, 70%, 50%)`),
                    hoverOffset: 4
                }]
            };

            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    aspectRatio: 1, // Ensures chart is square-ish
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.body.classList.contains('dark') ? 'rgb(209 213 219)' : 'rgb(55 65 81)', // Tailwind dark/light text
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = (value / convertToBase(totalValue) * 100).toFixed(1);
                                    return ` ${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const renderAssetList = () => {
            assetListEl.innerHTML = '';
            assetCountEl.textContent = assets.length;
            noAssetsMessageEl.classList.toggle('hidden', assets.length > 0);

            assets.forEach(asset => {
                const totalUSD = asset.quantity * asset.price;
                const totalBase = convertToBase(totalUSD);
                const changeAmount = totalUSD * (asset.change / 100);
                const changeBase = convertToBase(changeAmount);
                const isPositive = asset.change >= 0;

                const assetItem = document.createElement('div');
                assetItem.className = 'flex justify-between items-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm';
                assetItem.dataset.name = asset.name; // Use for identification

                assetItem.innerHTML = `
                    <div class="flex-grow min-w-0 pr-4">
                        <p class="text-lg font-semibold text-primary-600 dark:text-primary-400 text-clip">${asset.name}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-clip">
                            ${formatCurrency(convertToBase(asset.price))} @ ${asset.quantity.toFixed(4)}
                        </p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-lg font-bold">${formatCurrency(totalBase)}</p>
                        <p class="text-sm ${isPositive ? 'text-green-500' : 'text-red-500'}">
                            ${isPositive ? '▲' : '▼'} ${formatCurrency(changeBase)} (${formatPercentage(asset.change)})
                        </p>
                    </div>
                    <button class="delete-asset-btn ml-4 text-gray-400 hover:text-red-500 transition" data-asset-name="${asset.name}" title="Remove Asset">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;

                assetListEl.appendChild(assetItem);
            });

            // Attach delete handlers
            document.querySelectorAll('.delete-asset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const name = e.currentTarget.dataset.name;
                    deleteAsset(name);
                });
            });
        };

        const renderTotalSummary = () => {
            const totalValueUSD = calculateTotalValue();
            const totalValueBase = convertToBase(totalValueUSD);
            const change = calculateTotal24hChange();

            totalValueEl.textContent = formatCurrency(totalValueBase);
            baseCurrencyDisplayEl.textContent = `Base: ${baseCurrency}`;

            total24hChangeEl.textContent = `${change.amount > 0 ? '+' : ''}${formatCurrency(convertToBase(change.amount))} (${formatPercentage(change.percent)})`;
            total24hChangeEl.className = `text-lg font-medium ${change.percent >= 0 ? 'text-green-500' : 'text-red-500'}`;
        };

        const renderAll = () => {
            renderTotalSummary();
            renderAssetList();
            renderChart();
        };

        const addAsset = (name, quantity, price, change) => {
            // Check if asset already exists and update it, otherwise add new
            const existingIndex = assets.findIndex(a => a.name.toLowerCase() === name.toLowerCase());

            const newAsset = {
                name: name,
                quantity: parseFloat(quantity),
                price: parseFloat(price), // Stored as USD
                change: parseFloat(change || 0)
            };

            if (existingIndex > -1) {
                assets[existingIndex] = newAsset;
            } else {
                assets.push(newAsset);
            }

            saveAssets(); // Cloud sync
        };

        const deleteAsset = (name) => {
            assets = assets.filter(a => a.name !== name);
            saveAssets(); // Cloud sync
        };

        // --- Settings & UI Logic ---

        const loadSettings = () => {
            baseCurrency = localStorage.getItem('assetTrackerBaseCurrency') || 'USD';
            decimalPlaces = parseInt(localStorage.getItem('assetTrackerDecimalPlaces') || '2', 10);
            isPrivacyMode = localStorage.getItem('assetTrackerPrivacyMode') === 'true';
            const isDarkMode = localStorage.getItem('assetTrackerDarkMode') === 'true';

            baseCurrencyInput.value = baseCurrency;
            decimalPlacesInput.value = decimalPlaces;
            updatePrivacyView();
            updateDarkMode(isDarkMode);
        };

        const saveSettings = () => {
            baseCurrency = baseCurrencyInput.value.toUpperCase();
            decimalPlaces = parseInt(decimalPlacesInput.value, 10);

            // Settings are saved locally for immediate persistence of UI preferences
            localStorage.setItem('assetTrackerBaseCurrency', baseCurrency);
            localStorage.setItem('assetTrackerDecimalPlaces', decimalPlaces);

            populateCurrencyDatalists(); // Re-populate to include new base if it was manual entry
            updateExchangeRates(); // Must update rates immediately
            renderAll();
        };

        const updatePrivacyView = () => {
            if (isPrivacyMode) {
                totalValueEl.classList.add('blur-sm');
                total24hChangeEl.classList.add('blur-sm');
                privacyOnIcon.classList.add('hidden');
                privacyOffIcon.classList.remove('hidden');
            } else {
                totalValueEl.classList.remove('blur-sm');
                total24hChangeEl.classList.remove('blur-sm');
                privacyOnIcon.classList.remove('hidden');
                privacyOffIcon.classList.add('hidden');
            }
        };

        const updateDarkMode = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            localStorage.setItem('assetTrackerDarkMode', isDark);
            moonIcon.classList.toggle('hidden', isDark);
            sunIcon.classList.toggle('hidden', !isDark);
            if (chartInstance) {
                 // Re-render chart to update text color
                renderChart();
            }
        }

        // --- Exchange Rate Logic (Mocked) ---

        const updateExchangeRates = () => {
            ratesStatusEl.textContent = "Exchange Rates Status: Fetching...";
            const mockApiUrl = `https://api.exchangerate-api.com/v4/latest/USD`;

            // Simple mock API call - replace with real API if available
            fetch(mockApiUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Failed to fetch rates");
                    return response.json();
                })
                .then(data => {
                    exchangeRates = data.rates || { USD: 1.0 };
                    // If the user's base currency isn't in the rates, default to USD
                    if (!exchangeRates[baseCurrency]) {
                        baseCurrency = 'USD';
                        baseCurrencyInput.value = 'USD';
                        localStorage.setItem('assetTrackerBaseCurrency', 'USD');
                    }

                    ratesStatusEl.textContent = `Exchange Rates Status: Last updated ${new Date().toLocaleTimeString()}`;
                    ratesStatusEl.classList.remove('text-red-500');
                    ratesStatusEl.classList.add('text-green-500');

                    renderAll(); // Re-render when rates are updated
                })
                .catch(error => {
                    console.error("Exchange rate fetch error:", error);
                    exchangeRates = { USD: 1.0 }; // Fallback
                    ratesStatusEl.textContent = "Exchange Rates Status: Offline or failed. Using USD=1.0.";
                    ratesStatusEl.classList.remove('text-green-500');
                    ratesStatusEl.classList.add('text-red-500');
                    renderAll();
                });
        };

        const populateCurrencyDatalists = () => {
            const commonCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'CNY', 'INR', 'KRW', 'BRL'];
            currencyDatalist.innerHTML = commonCurrencies.map(c => `<option value="${c}">`).join('');
            if (baseCurrency && !commonCurrencies.includes(baseCurrency)) {
                // Add current base currency if it's not in the common list
                currencyDatalist.innerHTML += `<option value="${baseCurrency}">`;
            }
        };

        // --- Data Import/Export ---
        const exportData = () => {
            const settingsData = {
                baseCurrency: localStorage.getItem('assetTrackerBaseCurrency') || 'USD',
                decimalPlaces: localStorage.getItem('assetTrackerDecimalPlaces') || '2',
                darkMode: localStorage.getItem('assetTrackerDarkMode') || 'false',
                privacyMode: localStorage.getItem('assetTrackerPrivacyMode') || 'false',
            };
            const dataToZip = {
                'assets.json': JSON.stringify(assets, null, 2),
                'settings.json': JSON.stringify(settingsData, null, 2),
                'metadata.txt': `Asset Tracker Data Export\nUser ID: ${currentUserId}\nApp ID: ${appId}\nExport Date: ${new Date().toISOString()}`,
            };

            const zip = new JSZip();
            for (const [filename, content] of Object.entries(dataToZip)) {
                zip.file(filename, content);
            }

            zip.generateAsync({ type: 'blob' })
                .then(content => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = `asset_tracker_export_${new Date().toISOString().substring(0, 10)}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                })
                .catch(err => console.error("Export failed:", err));
        };

        const importData = (file) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const zip = new JSZip();
                zip.loadAsync(e.target.result)
                    .then(zip => {
                        return Promise.all([
                            zip.file('assets.json')?.async('text'),
                            zip.file('settings.json')?.async('text')
                        ]);
                    })
                    .then(([assetsJson, settingsJson]) => {
                        if (assetsJson) {
                            try {
                                assets = JSON.parse(assetsJson);
                                saveAssets(); // Save imported assets to the cloud
                            } catch (e) {
                                console.error("Failed to parse assets.json", e);
                            }
                        }
                        if (settingsJson) {
                            try {
                                const settings = JSON.parse(settingsJson);
                                // Load settings locally
                                localStorage.setItem('assetTrackerBaseCurrency', settings.baseCurrency);
                                localStorage.setItem('assetTrackerDecimalPlaces', settings.decimalPlaces);
                                localStorage.setItem('assetTrackerDarkMode', settings.darkMode);
                                localStorage.setItem('assetTrackerPrivacyMode', settings.privacyMode);
                                loadSettings();
                            } catch (e) {
                                console.error("Failed to parse settings.json", e);
                            }
                        }
                        alertMessage('Data imported and synced successfully!', 'green');
                        renderAll();
                    })
                    .catch(e => {
                        console.error("Import failed:", e);
                        alertMessage('Import failed. Invalid ZIP file format.', 'red');
                    });
            };
            reader.readAsArrayBuffer(file);
        };

        // --- Clear Data Function ---
        const clearAllCloudData = async () => {
            if (!confirm('Are you sure you want to permanently clear ALL data from the cloud? This action cannot be undone.')) return;

            const docRef = getAssetDocRef();
            if (!docRef) {
                alertMessage('Error: Could not access cloud data reference.', 'red');
                return;
            }
            try {
                await setDoc(docRef, { assets: [], lastUpdated: new Date() });
                assets = [];
                renderAll();
                settingsModal.classList.add('hidden');
                alertMessage('All cloud data cleared successfully. Local state is now empty.', 'green');
            } catch (error) {
                console.error("Error clearing cloud data:", error);
                alertMessage('Failed to clear cloud data. Check console for details.', 'red');
            }
        };

        // --- Simple Custom Alert (No window.alert) ---
        const alertMessage = (message, color) => {
            const colorMap = {
                'green': 'bg-green-500',
                'red': 'bg-red-500',
                'yellow': 'bg-yellow-500'
            };
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 z-[9999] ${colorMap[color] || 'bg-blue-500'} text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0`;
            div.textContent = message;
            document.body.appendChild(div);

            setTimeout(() => div.classList.remove('opacity-0'), 10);
            setTimeout(() => {
                div.classList.add('opacity-0');
                div.addEventListener('transitionend', () => div.remove());
            }, 3000);
        };


        // --- Initialization and Auth ---

        const initializeFirebaseAndAuth = () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Running in local-only mode.");
                authStatusEl.textContent = 'ERROR: Missing Firebase Config. Cloud Sync Disabled.';
                // Fallback to local storage (only needed if Firestore fails, but good safety net)
                assets = JSON.parse(localStorage.getItem('assets') || '[]');
                renderAll();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = 'Authenticating user...';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        appIdDisplay.textContent = appId;
                        loadAssets(); // Start listening for data once authenticated
                        isAuthReady = true;
                    } else if (initialAuthToken) {
                        // Use provided custom token for sign in
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.error("Custom token sign in failed, signing in anonymously:", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        // Sign in anonymously if no token is provided
                        try {
                            await signInAnonymously(auth);
                        } catch (e) {
                            console.error("Anonymous sign in failed:", e);
                            authStatusEl.textContent = `Authentication Failed. Error: ${e.code}`;
                            authStatusEl.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                            authStatusEl.classList.add('bg-red-100', 'dark:bg-red-900');
                            // Fallback to local storage
                            assets = JSON.parse(localStorage.getItem('assets') || '[]');
                            renderAll();
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                authStatusEl.textContent = `FATAL ERROR: Firebase Init Failed. ${e.message}`;
                authStatusEl.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                authStatusEl.classList.add('bg-red-100', 'dark:bg-red-900');
            }
        };

        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {

            // --- Form Submission ---
            addAssetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('asset-name').value.trim();
                const quantity = document.getElementById('asset-quantity').value;
                const price = document.getElementById('asset-price').value;
                const change = document.getElementById('asset-24h-change').value || 0;

                if (name && parseFloat(quantity) >= 0 && parseFloat(price) >= 0) {
                    addAsset(name, quantity, price, change);
                    addAssetForm.reset();
                    document.getElementById('asset-name').focus();
                } else {
                    alertMessage('Please enter valid asset details.', 'yellow');
                }
            });

            // --- Modal and Settings ---
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
                // Ensure inputs reflect current state when opening
                baseCurrencyInput.value = baseCurrency;
                decimalPlacesInput.value = decimalPlaces;
            });
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            saveSettingsBtn.addEventListener('click', () => {
                saveSettings();
                settingsModal.classList.add('hidden');
            });
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            // Data Management buttons
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) importData(file);
                e.target.value = ''; // Clear input for next import
            });
            document.getElementById('clear-all-data-btn').addEventListener('click', clearAllCloudData);

            // --- Dark Mode ---
            darkModeToggle.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('dark');
                updateDarkMode(isDark);
            });

            // --- Privacy Toggle ---
            privacyToggleBtn.addEventListener('click', () => {
                isPrivacyMode = !isPrivacyMode;
                localStorage.setItem('assetTrackerPrivacyMode', isPrivacyMode);
                updatePrivacyView();
                renderAll();
            });

            // --- Service Worker ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js').then(registration => {
                        console.log('SW registration successful');
                    }, err => {
                        console.log('SW registration failed: ', err);
                    });
                });
            }

            // --- Initial Load ---
            loadSettings(); // Load local settings (currency, decimals, theme)
            populateCurrencyDatalists();
            updateExchangeRates();
            setInterval(updateExchangeRates, 3600000); // Update every hour

            // --- Firebase Initialization ---
            initializeFirebaseAndAuth();

            // --- Online/Offline Handling ---
            function handleOnlineStatus() {
                if (navigator.onLine) {
                    offlineBanner.classList.remove('show');
                } else {
                    offlineBanner.classList.add('show');
                    offlineBannerMessage.textContent = "You are offline. Cloud sync will resume automatically.";
                }
            }

            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOnlineStatus);
            handleOnlineStatus(); // Initial check
        });
    </script>
</body>
</html>
